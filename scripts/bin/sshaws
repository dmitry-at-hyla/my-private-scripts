#!/bin/bash

ENV=dev
PROGRAM=hyla
APP=cs
SERVER_NO=1

while (( "$#" ))
do
    ARG=$1
    case ${ARG} in
        bastion|\
        cs|commonservices|common-services|\
        csweb|cs-web|web|commonservicesweb|common-services-web|commonservices-web|\
        ce|cew|ce-web|ceweb|cewweb|cew-web|\
        batch|batch-server|batchserver|\
        qd|quartzdesk|batch-console|batchconsole|\
        sc|springcloud|spring-cloud|cloud|\
        rmq|rabbitmq|\
        sonar|sonarqube|\
        es|elastic|elastic-search|elastic-search|\
        mock|wiremock|wire-mock|mockserver|mock-server)
            APP=${ARG}
            ;;
        dev|qa|uat|prod|tst|stg)
            ENV=${ARG}
            ;;
        [1-9])
            SERVER_NO=${ARG}
            ;;
        --)
            shift
            COMMAND=$*
            shift $#
            ;;
        *)
            PROGRAM=${ARG}
            ;;
    esac
    shift
done

BASTION=$(bastions ${PROGRAM} ${ENV})

# Special cases region

if [[ "${PROGRAM}" == "old-google" ]]
then
    case ${APP} in
    ce)
        SERVER=gce-appserver
        ;;
    cew)
        SERVER=gcew-appserver
        ;;
    ceweb|ce-web)
        SERVER=gce-webserver
        ;;
    cewweb|cew-web)
        SERVER=gcew-webserver
        ;;
    batch|batch-server|batchserver)
        SERVER=batch-server
        ;;
    esac
fi

# End of special cases region

if [[ "${SERVER}" == "" ]]
then
    case ${APP} in
    cs|commonservices|common-services)
        SERVER=${ENV}-appserver-${PROGRAM}-cs
        ;;
    ce)
        SERVER=${ENV}-appserver-${PROGRAM}-ce
        ;;
    cew)
        SERVER=${ENV}-appserver-${PROGRAM}-cew
        ;;
    csweb|cs-web|web|commonservicesweb|common-services-web|commonservices-web)
        SERVER=${ENV}-webserver-${PROGRAM}-cs
        ;;
    ceweb|ce-web)
        SERVER=${ENV}-webserver-${PROGRAM}-ce
        ;;
    cewweb|cew-web)
        SERVER=${ENV}-webserver-${PROGRAM}-cew
        ;;
    batch|batch-server|batchserver)
        SERVER=${ENV}-batchserver-${PROGRAM}
        ;;
    qd|quartzdesk|batch-console|batchconsole)
        SERVER=${ENV}-batch-console
        ;;
    sc|springcloud|spring-cloud|cloud)
        SERVER=${ENV}-springcloud-server
        ;;
    rmq|rabbitmq)
        SERVER=${ENV}-rmq
        ;;
    sonar|sonarqube)
        SERVER=${ENV}-${PROGRAM}-sonar
        ;;
    es|elastic|elastic-search|elastic-search)
        SERVER=${ENV}-elastic-search7
        ;;
    mock|wiremock|wire-mock|mockserver|mock-server)
        SERVER=${ENV}-wire-mock
        ;;
    *)
        SERVER=${ENV}-appserver-${PROGRAM}-cs
        ;;
    esac
fi

if [[ "${APP}" != "bastion" ]]
then
    SERVER_COMMAND="awsssh ${SERVER}-${SERVER_NO}"
fi

echo ssh -q -t -o StrictHostKeyChecking=no ${BASTION} ${SERVER_COMMAND} ${COMMAND} >&2
expect -c "
spawn ssh -q -t -o StrictHostKeyChecking=no ${BASTION} ${SERVER_COMMAND} ${COMMAND}
expect "'"'"Verification code:"'"'"
send 11111111\r
interact
"
